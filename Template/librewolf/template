# Template file for 'librewolf'
pkgname=librewolf
version=147.0.4
_number=1
revision=1
archs="x86_64"
hostmakedepends="gnupg"
depends="
gtk+3
libXt
startup-notification
mime-types
dbus
nss
freefont-ttf
libpulseaudio
ffmpeg
hicolor-icon-theme
libXdamage
libXi
alsa-lib
libXrender
libXcursor
gdk-pixbuf
libXrandr
pango
freetype
glibc
bash
fontconfig
libXcomposite
glib
libgcc
libX11
libXfixes
at-spi2-core
libxcb
cairo
nspr
libXext
"
short_desc="Community-maintained fork of Firefox, focused on privacy, security and freedom."
maintainer="Eren Öztürk <erenozturkhde@gmail.com>"
license="MPL-2.0"
homepage="https://librewolf.net/"

distfiles="
	https://codeberg.org/api/packages/librewolf/generic/librewolf/${version}-${_number}/librewolf-${version}-${_number}-linux-x86_64-package.tar.xz
	https://codeberg.org/api/packages/librewolf/generic/librewolf/${version}-${_number}/librewolf-${version}-${_number}-linux-x86_64-package.tar.xz.sig
	https://repo.librewolf.net/pubkey.gpg
"


checksum="
	cea5aaf0581d48b5806a85af9829c873d1654e642d70280ba0af57b97b164b83
	fbe329046a32dcd64b787ee9b2598fe3fa2d94f76aad894af34e5f638353ac7a
	9ced1a0ce0216bbd16cb95847584892ddb3642718530407aeb5b6b0642d3d24a
	"

skip_extraction="librewolf-${version}-${_number}-linux-x86_64-package.tar.xz.sig pubkey.gpg"

do_verify() {
    echo "Verifying LibreWolf GPG signature..."

    export GNUPGHOME="$XBPS_SRCDISTDIR/librewolf-${version}/.gnupg_temp"
    mkdir -p "$GNUPGHOME"
    chmod 700 "$GNUPGHOME"

    gpg --batch --no-tty --import "$XBPS_SRCDISTDIR/librewolf-${version}/pubkey.gpg"

    gpg --batch --no-tty --verify \
        "$XBPS_SRCDISTDIR/librewolf-${version}/librewolf-${version}-${_number}-linux-x86_64-package.tar.xz.sig" \
        "$XBPS_SRCDISTDIR/librewolf-${version}/librewolf-${version}-${_number}-linux-x86_64-package.tar.xz"

    rm -rf "$GNUPGHOME"
}

do_install(){

	do_verify

	vmkdir /usr/lib/librewolf
	vmkdir /usr/bin

	vcopy $wrksrc/* "/usr/lib/librewolf/"

	cd $wrksrc
	local vendorjs="$DESTDIR/usr/lib/${pkgname}/browser/defaults/preferences/vendor.js"

	install -Dvm644 /dev/stdin "$vendorjs" <<END
// Use system-provided dictionaries
pref("spellchecker.dictionary_path", "/usr/share/hunspell");

// Don't disable extensions in the application directory
// done in librewolf.cfg
// pref("extensions.autoDisableScopes", 11);
END

	local distini="$DESTDIR/usr/lib/${pkgname}/distribution/distribution.ini"
	install -Dvm644 /dev/stdin "$distini" <<END
	[Global]
id=io.gitlab.${pkgname}-community
version=1.0
about=LibreWolf

[Preferences]
app.distributor="LibreWolf Community"
app.distributor.channel=${pkgname}
app.partner.librewolf=${pkgname}
END

	for i in 16 32 48 64 128; do
		install -Dvm644 "$wrksrc/browser/chrome/icons/default/default$i.png" \
			"$DESTDIR/usr/share/icons/hicolor/${i}x${i}/apps/${pkgname}.png"
	done

	  install -Dvm644 ${FILESDIR}/default192x192.png \
    "$DESTDIR/usr/share/icons/hicolor/192x192/apps/${pkgname}.png"

	install -Dvm644 "${FILESDIR}/${pkgname}.desktop" \
    "$DESTDIR/usr/share/applications/${pkgname}.desktop"


	install -Dvm755 /dev/stdin "$DESTDIR/usr/bin/${pkgname}" <<END
#!/bin/sh
exec /usr/lib/${pkgname}/librewolf "\$@"
END

ln -srfv "$DESTDIR/usr/bin/${pkgname}" "$DESTDIR/usr/lib/${pkgname}/librewolf-bin"
local nssckbi="$DESTDIR/usr/lib/${pkgname}/libnssckbi.so"
if [[ -e $nssckbi ]]; then
	ln -srfv "$DESTDIR/usr/lib/libnssckbi.so" "$nssckbi"
fi
}
